<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è»Šè³‡ä¼°ç®—</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMAZg7iKcByv3cZRevkdrVOFEFrGr8y1c&libraries=places&callback=initMap" async defer></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;
            background:linear-gradient(135deg,#000 0%,#1a1a1a 100%);
            min-height:100vh;color:#fff;padding:20px
        }
        .container{
            max-width:400px;margin:0 auto;background:#fff;
            border-radius:20px;box-shadow:0 25px 50px rgba(0,0,0,.4);overflow:hidden
        }
        .header{
            background:linear-gradient(135deg,#000 0%,#333 100%);
            color:#fff;padding:30px 25px;text-align:center
        }
        .header h1{font-size:24px;font-weight:600;margin-bottom:8px}
        .header p{font-size:14px;opacity:.9}
        .content{padding:30px 25px}
        .location-section{margin-bottom:25px}
        .location-label{font-size:14px;color:#666;margin-bottom:8px;font-weight:500}
        .location-btn{
            width:100%;background:linear-gradient(135deg,#000 0%,#333 100%);
            color:#fff;border:none;padding:16px 20px;font-size:16px;font-weight:500;
            border-radius:12px;cursor:pointer;transition:all .3s ease;
            display:flex;align-items:center;justify-content:center;gap:10px;
            box-shadow:0 4px 15px rgba(0,0,0,.2)
        }
        .location-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.3)}
        .location-btn:active{transform:translateY(0)}
        .location-btn:disabled{background:#ccc;cursor:not-allowed;box-shadow:none}
        .location-btn.loading{background:#ccc;cursor:not-allowed}
        .location-input{
            width:100%;padding:16px 20px;border:2px solid #e0e0e0;
            border-radius:12px;font-size:16px;transition:all .3s ease;background:#f8f8f8
        }
        .location-input:focus{
            outline:none;border-color:#000;background:#fff;
            box-shadow:0 0 0 3px rgba(0,0,0,.1)
        }
        .location-display{
            background:#f0f0f0;padding:16px 20px;border-radius:12px;
            font-size:16px;color:#333;margin-bottom:15px;position:relative;padding-left:45px
        }
        .location-display::before{
            content:"ğŸ“";position:absolute;left:15px;top:50%;
            transform:translateY(-50%);font-size:20px
        }
        .switch-input-btn{
            width:100%;margin-top:10px;background:transparent;color:#000;
            border:1px solid #000;padding:10px;font-size:14px;font-weight:500;
            border-radius:8px;cursor:pointer;transition:all .3s ease
        }
        .switch-input-btn:hover{background:#000;color:#fff}
        .calculate-btn{
            width:100%;background:linear-gradient(135deg,#000 0%,#333 100%);
            color:#fff;border:none;padding:18px;font-size:18px;font-weight:600;
            border-radius:12px;cursor:pointer;transition:all .3s ease;
            margin-top:20px;box-shadow:0 4px 15px rgba(0,0,0,.2)
        }
        .calculate-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.3)}
        .calculate-btn:disabled{background:#ccc;cursor:not-allowed;transform:none;box-shadow:none}
        .fare-result{
            margin-top:25px;padding:25px;
            background:linear-gradient(135deg,#f8f8f8 0%,#fff 100%);
            border-radius:15px;text-align:center;display:none;border:1px solid #e0e0e0
        }
        .fare-amount{font-size:36px;font-weight:700;color:#000;margin-bottom:10px}
        .fare-range{font-size:14px;color:#666;margin-bottom:15px}
        .route-info{font-size:13px;color:#888;margin-bottom:20px;line-height:1.5}
        #map{height:250px;width:100%;margin-top:15px;border-radius:12px;overflow:hidden}
        .confirm-btn{
            width:100%;background:#fff;color:#000;border:2px solid #d0d0d0;
            padding:18px;font-size:18px;font-weight:600;border-radius:12px;
            cursor:pointer;transition:all .3s ease;box-shadow:0 2px 8px rgba(0,0,0,.1)
        }
        .confirm-btn:hover{background:#f8f8f8;border-color:#b0b0b0;transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.15)}
        .confirm-btn:active{transform:translateY(0);box-shadow:0 2px 8px rgba(0,0,0,.1)}
        .confirm-btn:disabled{background:#f0f0f0;color:#999;border-color:#e0e0e0;cursor:not-allowed}
        .loading{display:inline-block;width:20px;height:20px;border:3px solid #f3f3f3;border-top:3px solid #000;border-radius:50%;animation:spin 1s linear infinite;margin-right:10px;vertical-align:middle}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .status-message{text-align:center;padding:20px;font-size:16px;font-weight:500}
        .status-success{color:#00aa00}
        .status-error{color:#d32f2f}
        .hidden{display:none !important}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>è»Šè³‡ä¼°ç®—ç³»çµ±</h1>
            <p>ä¼°ç®—æ‚¨çš„è»Šè³‡è²»ç”¨</p>
        </div>
        
        <div class="content">
            <!-- ä¸Šè»Šåœ°é» -->
            <div class="location-section">
                <div class="location-label">ä¸Šè»Šåœ°é»</div>
                <!-- å®šä½æŒ‰éˆ• -->
                <button id="getLocationBtn" class="location-btn" onclick="getCurrentLocation()">
                    <span class="location-icon">ğŸ“</span>é»æ“Šç²å–ä½ç½®
                </button>
                <!-- æ‰‹å‹•è¼¸å…¥æ¡†ï¼ˆé è¨­éš±è—ï¼‰ -->
                <input type="text" id="manualPickupInput" class="location-input hidden" placeholder="è«‹è¼¸å…¥å®Œæ•´ä¸Šè»Šåœ°å€">
                <!-- åˆ‡æ›æŒ‰éˆ• -->
                <button id="switchPickupBtn" class="switch-input-btn" onclick="togglePickupInput()">âœï¸ æ”¹ç‚ºæ‰‹å‹•è¼¸å…¥ä¸Šè»Šåœ°é»</button>
                <!-- å·²é¸åœ°å€é¡¯ç¤º -->
                <div id="pickupLocation" class="location-display hidden">å°šæœªé¸æ“‡ä¸Šè»Šåœ°é»</div>
            </div>

            <!-- ä¸‹è»Šåœ°é» -->
            <div class="location-section">
                <div class="location-label">ä¸‹è»Šåœ°é»</div>
                <input type="text" id="dropoffLocation" class="location-input" placeholder="è«‹è¼¸å…¥å®Œæ•´ä¸‹è»Šåœ°å€">
            </div>

            <!-- ä¼°ç®—æŒ‰éˆ• -->
            <button id="calculateBtn" class="calculate-btn" onclick="calculateFare()">
                <span id="btnText">ä¼°ç®—è»Šè³‡</span>
            </button>

            <!-- è¨ˆç®—çµæœ -->
            <div id="fareResult" class="fare-result">
                <div class="fare-amount" id="fareAmount">$0</div>
                <div class="fare-range" id="fareRange">æµ®å‹• Â±5%</div>
                <div class="route-info" id="routeInfo">
                    è·é›¢ï¼š<span id="distance">0</span>å…¬é‡Œ | é ä¼°æ™‚é–“ï¼š<span id="duration">0</span>åˆ†é˜
                </div>
                <div id="map"></div>
                <button class="confirm-btn" onclick="confirmBooking()">
                    <span style="font-weight:700;">ç¢ºèªå«è»Š</span>
                </button>
            </div>

            <div id="statusMessage" class="status-message hidden"></div>
        </div>
    </div>

    <script>
        const liffId = "2008784977-s1enHy4P";
        const googleApiKey = "AIzaSyCMAZg7iKcByv3cZRevkdrVOFEFrGr8y1c";

        let pickupCoords = null;
        let dropoffCoords = null;
        let calculatedDistance = 0;
        let calculatedDuration = 0;
        let baseFare = 0;

        let map;
        let directionsRenderer;

        const FARE_RULES = {
            baseFare: 80,
            perKm: 15,
            perMinute: 3,
            longDistanceThreshold: 20,
            longDistanceSurcharge: 10,
            floatingRange: 0.05
        };

        async function initializeLiff() {
            try {
                await liff.init({ liffId });
                console.log("LIFF initialized");
            } catch (err) {
                console.error(err);
                showStatus("ç³»çµ±åˆå§‹åŒ–å¤±æ•—", "error");
            }
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 13,
                center: { lat: 24.1477, lng: 120.6736 }
            });
            directionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: false,
                polylineOptions: { strokeColor: "#000", strokeOpacity: 0.8, strokeWeight: 5 }
            });
            directionsRenderer.setMap(map);
        }

        /* -------- ä¸Šè»Šåœ°é»ï¼šå®šä½ / æ‰‹å‹• åˆ‡æ› -------- */
        function togglePickupInput() {
            const btn = document.getElementById('getLocationBtn');
            const input = document.getElementById('manualPickupInput');
            const switchBtn = document.getElementById('switchPickupBtn');
            const display = document.getElementById('pickupLocation');

            if (input.classList.contains('hidden')) {
                // åˆ‡æ›æˆæ‰‹å‹•è¼¸å…¥æ¨¡å¼
                btn.classList.add('hidden');
                input.classList.remove('hidden');
                display.classList.add('hidden');
                switchBtn.textContent = "ğŸ“ æ”¹ç‚ºå®šä½ç²å–";
                pickupCoords = null;
            } else {
                // åˆ‡å›å®šä½æ¨¡å¼
                btn.classList.remove('hidden');
                input.classList.add('hidden');
                display.classList.add('hidden');
                switchBtn.textContent = "âœï¸ æ”¹ç‚ºæ‰‹å‹•è¼¸å…¥ä¸Šè»Šåœ°é»";
                pickupCoords = null;
            }
        }

        /* -------- å®šä½ç²å– -------- */
        function getCurrentLocation() {
            const button = document.getElementById('getLocationBtn');
            const display = document.getElementById('pickupLocation');

            if (!navigator.geolocation) { showStatus("è£ç½®ä¸æ”¯æ´å®šä½", "error"); return; }

            button.innerHTML = '<span class="loading"></span>ç²å–ä½ç½®ä¸­...';
            button.disabled = true;

            navigator.geolocation.getCurrentPosition(
                pos => {
                    pickupCoords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    const geocoder = new google.maps.Geocoder();
                    const latLng = new google.maps.LatLng(pickupCoords.lat, pickupCoords.lng);
                    geocoder.geocode({ location: latLng }, (results, status) => {
                        let addr = `ç•¶å‰ä½ç½® (${pickupCoords.lat.toFixed(4)}, ${pickupCoords.lng.toFixed(4)})`;
                        if (status === "OK" && results && results.length) addr = results[0].formatted_address;
                        display.textContent = addr;
                        display.classList.remove('hidden');
                        button.style.display = 'none';
                        showStatus("ä½ç½®ç²å–æˆåŠŸï¼", "success");
                    });
                },
                err => {
                    let msg = { 1: "è«‹å…è¨±å®šä½æ¬Šé™", 2: "ä½ç½®ç„¡æ³•ä½¿ç”¨", 3: "ç²å–è¶…æ™‚" }[err.code] || "ç²å–å¤±æ•—";
                    showStatus(msg, "error");
                    button.innerHTML = '<span class="location-icon">ğŸ“</span>é»æ“Šç²å–ä½ç½®';
                    button.disabled = false;
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
        }

        /* -------- æ‰‹å‹•è¼¸å…¥ä¸Šè»Šåœ°å€è½‰åæ¨™ -------- */
        function getManualPickupCoords() {
            return new Promise((resolve, reject) => {
                const addr = document.getElementById('manualPickupInput').value.trim();
                if (!addr) { resolve(null); return; }
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: addr }, (results, status) => {
                    if (status === "OK" && results && results.length) {
                        const loc = results[0].geometry.location;
                        resolve({ lat: loc.lat(), lng: loc.lng() });
                    } else {
                        resolve(null);
                    }
                });
            });
        }

        /* -------- ä¼°ç®—è»Šè³‡ -------- */
        async function calculateFare() {
            const dropoffAddress = document.getElementById('dropoffLocation').value.trim();
            if (!dropoffAddress) { showStatus("è«‹è¼¸å…¥ä¸‹è»Šåœ°å€", "error"); return; }

            // åˆ¤æ–·ä¸Šè»Šä¾†æº
            const manualInput = document.getElementById('manualPickupInput');
            if (!manualInput.classList.contains('hidden')) {
                // æ‰‹å‹•æ¨¡å¼
                pickupCoords = await getManualPickupCoords();
                if (!pickupCoords) { showStatus("ç„¡æ³•è§£æä¸Šè»Šåœ°å€", "error"); return; }
                const display = document.getElementById('pickupLocation');
                display.textContent = manualInput.value;
                display.classList.remove('hidden');
            } else {
                // å®šä½æ¨¡å¼
                if (!pickupCoords) { showStatus("è«‹å…ˆç²å–ä¸Šè»Šä½ç½®", "error"); return; }
            }

            const button = document.getElementById('calculateBtn');
            const btnText = document.getElementById('btnText');
            btnText.innerHTML = '<span class="loading"></span>è¨ˆç®—ä¸­...';
            button.disabled = true;

            // ä¸‹è»Šåœ°å€è½‰åæ¨™
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: dropoffAddress }, (results, status) => {
                if (status === "OK" && results && results.length) {
                    const loc = results[0].geometry.location;
                    dropoffCoords = { lat: loc.lat(), lng: loc.lng() };

                    const directionsService = new google.maps.DirectionsService();
                    directionsService.route({
                        origin: new google.maps.LatLng(pickupCoords.lat, pickupCoords.lng),
                        destination: new google.maps.LatLng(dropoffCoords.lat, dropoffCoords.lng),
                        travelMode: google.maps.TravelMode.DRIVING,
                        language: 'zh-TW'
                    }, (result, status) => {
                        if (status === "OK" && result.routes && result.routes.length) {
                            const leg = result.routes[0].legs[0];
                            calculatedDistance = leg.distance.value / 1000;
                            calculatedDuration = leg.duration.value / 60;
                            baseFare = calculateBaseFare(calculatedDistance, calculatedDuration);
                            displayFareResult(baseFare, calculatedDistance, calculatedDuration);
                            directionsRenderer.setDirections(result);
                        } else {
                            showStatus("ç„¡æ³•è¦åŠƒè·¯ç·š", "error");
                        }
                        btnText.textContent = "ä¼°ç®—è»Šè³‡";
                        button.disabled = false;
                    });
                } else {
                    showStatus("æ‰¾ä¸åˆ°ä¸‹è»Šåœ°é»", "error");
                    btnText.textContent = "ä¼°ç®—è»Šè³‡";
                    button.disabled = false;
                }
            });
        }

        function calculateBaseFare(distance, duration) {
            let fare = FARE_RULES.baseFare;
            fare += distance * FARE_RULES.perKm;
            fare += duration * FARE_RULES.perMinute;
            if (distance > FARE_RULES.longDistanceThreshold) {
                const extra = distance - FARE_RULES.longDistanceThreshold;
                fare += extra * FARE_RULES.longDistanceSurcharge;
            }
            const floatingAmount = fare * FARE_RULES.floatingRange;
            return {
                base: Math.round(fare),
                min: Math.round(fare - floatingAmount),
                max: Math.round(fare + floatingAmount)
            };
        }

        function displayFareResult(fareData, distance, duration) {
            document.getElementById('fareAmount').textContent = `$${fareData.base}`;
            document.getElementById('fareRange').textContent = `æµ®å‹•ç¯„åœ $${fareData.min} - $${fareData.max}`;
            document.getElementById('distance').textContent = distance.toFixed(1);
            document.getElementById('duration').textContent = Math.round(duration);
            document.getElementById('fareResult').style.display = 'block';
            hideStatus();
        }

        async function confirmBooking() {
            if (!pickupCoords) { showStatus("ç„¡æ³•ç²å–ä¸Šè»Šä½ç½®", "error"); return; }
            showStatus("æ­£åœ¨è™•ç†å«è»Š...", "loading");
            const geocoder = new google.maps.Geocoder();
            const latLng = new google.maps.LatLng(pickupCoords.lat, pickupCoords.lng);
            geocoder.geocode({ location: latLng }, async (results, status) => {
                let pickupAddress = "ç•¶å‰ä½ç½®";
                if (status === "OK" && results && results.length) pickupAddress = results[0].formatted_address;
                if (liff.isInClient()) {
                    const dropoffAddress = document.getElementById('dropoffLocation').value.trim();
                    const message = `ğŸš— å«è»Šè³‡è¨Š\nä¸Šè»Šï¼š${pickupAddress}\nä¸‹è»Šï¼š${dropoffAddress}`;
                    await liff.sendMessages([{ type: "text", text: message }]);
                    showStatus("å«è»Šè«‹æ±‚å·²ç™¼é€ï¼", "success");
                    setTimeout(() => liff.closeWindow(), 1500);
                } else {
                    showStatus("è«‹åœ¨LINEä¸­é–‹å•Ÿæ­¤é é¢", "error");
                }
            });
        }

        function showStatus(message, type = "") {
            const st = document.getElementById('statusMessage');
            st.textContent = message;
            st.className = "status-message " + type;
            st.style.display = 'block';
            if (type !== "loading") setTimeout(() => st.style.display = 'none', 3000);
        }
        function hideStatus() { document.getElementById('statusMessage').style.display = 'none'; }

        initializeLiff();
    </script>
</body>
</html>
